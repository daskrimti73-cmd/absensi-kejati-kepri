<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Query - Debug Supabase</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Courier New', monospace;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #252526;
            padding: 20px;
            border-radius: 8px;
        }
        h1 {
            color: #4ec9b0;
        }
        button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        button:hover {
            background: #1177bb;
        }
        #result {
            margin-top: 20px;
            padding: 15px;
            background: #1e1e1e;
            border: 1px solid #3c3c3c;
            border-radius: 4px;
            white-space: pre-wrap;
            font-size: 12px;
            max-height: 600px;
            overflow-y: auto;
        }
        .success { color: #4ec9b0; }
        .error { color: #f48771; }
        .warning { color: #dcdcaa; }
        .info { color: #9cdcfe; }
        input, select {
            padding: 8px;
            margin: 5px;
            background: #3c3c3c;
            border: 1px solid #555;
            color: #d4d4d4;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Supabase Query Debugger</h1>
        <p>Tool untuk mengecek data di Supabase</p>
        
        <div style="margin: 20px 0;">
            <label>Tahun: </label>
            <input type="number" id="tahun" value="2025" style="width: 100px;">
            
            <label>Bulan: </label>
            <select id="bulan">
                <option value="Januari">Januari</option>
                <option value="Februari">Februari</option>
                <option value="Maret">Maret</option>
                <option value="April">April</option>
                <option value="Mei">Mei</option>
                <option value="Juni">Juni</option>
                <option value="Juli">Juli</option>
                <option value="Agustus">Agustus</option>
                <option value="September" selected>September</option>
                <option value="Oktober">Oktober</option>
                <option value="November">November</option>
                <option value="Desember">Desember</option>
            </select>
            
            <label>Bidang: </label>
            <select id="bidang">
                <option value="GABUNGAN" selected>GABUNGAN</option>
                <option value="PEMBINAAN">PEMBINAAN</option>
                <option value="INTELIJEN">INTELIJEN</option>
                <option value="PIDUM">PIDUM</option>
                <option value="PIDSUS">PIDSUS</option>
                <option value="DATUN">DATUN</option>
                <option value="PENGAWASAN">PENGAWASAN</option>
                <option value="TATA USAHA">TATA USAHA</option>
                <option value="KOORDINATOR">KOORDINATOR</option>
                <option value="PEMULIHAN ASET">PEMULIHAN ASET</option>
            </select>
        </div>
        
        <div>
            <button onclick="checkAllDatabase()">üóÑÔ∏è CHECK ALL DATABASE (START HERE!)</button>
            <button onclick="testQuery()">üîç Test Query Absensi</button>
            <button onclick="testRekapitulasi()">üìä Test Query Rekapitulasi</button>
            <button onclick="clearResult()">üóëÔ∏è Clear</button>
        </div>
        
        <div id="result"></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://iudtxznbakaqzygpkaxf.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml1ZHR4em5iYWthcXp5Z3BrYXhmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwODQ3MjIsImV4cCI6MjA4NTY2MDcyMn0.eF_idmb2tF_SJtOJ7Sf9ipcT7w5Zhxt30uzMqtptxmc';
        
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        function log(message, type = 'info') {
            const result = document.getElementById('result');
            const className = type;
            const timestamp = new Date().toLocaleTimeString();
            result.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            result.scrollTop = result.scrollHeight;
        }
        
        function clearResult() {
            document.getElementById('result').innerHTML = '';
        }
        
        async function checkAllDatabase() {
            clearResult();
            
            log('='.repeat(60), 'info');
            log('üóÑÔ∏è CHECKING ALL DATABASE', 'success');
            log('='.repeat(60), 'info');
            log('', 'info');
            
            try {
                // Check total rows in absensi table
                log('‚è≥ Checking absensi table...', 'warning');
                const { data: allAbsensi, error: err1 } = await supabaseClient
                    .from('absensi')
                    .select('*');
                
                if (err1) {
                    log('‚ùå ERROR querying absensi:', 'error');
                    log(JSON.stringify(err1, null, 2), 'error');
                    return;
                }
                
                log(`‚úÖ Total rows in absensi: ${allAbsensi.length}`, 'success');
                log('', 'info');
                
                if (allAbsensi.length === 0) {
                    log('‚ö†Ô∏è DATABASE IS EMPTY!', 'error');
                    log('', 'info');
                    log('üí° This means:', 'warning');
                    log('   1. No data has been uploaded yet', 'warning');
                    log('   2. OR all data was deleted', 'warning');
                    log('   3. OR you are connected to wrong database', 'warning');
                    log('', 'info');
                    log('üîß Solution: Upload data via admin panel', 'info');
                    return;
                }
                
                // Group by year and month
                const grouped = {};
                allAbsensi.forEach(row => {
                    const key = `${row.tahun}-${row.bulan}`;
                    if (!grouped[key]) {
                        grouped[key] = { total: 0, bidang: {} };
                    }
                    grouped[key].total++;
                    
                    const bidang = row.bidang || 'Unknown';
                    if (!grouped[key].bidang[bidang]) {
                        grouped[key].bidang[bidang] = 0;
                    }
                    grouped[key].bidang[bidang]++;
                });
                
                log('üìä Data by Month:', 'success');
                Object.entries(grouped).sort().forEach(([key, info]) => {
                    log(`\nüìÖ ${key}`, 'info');
                    log(`   Total: ${info.total} rows`, 'success');
                    Object.entries(info.bidang).sort((a, b) => b[1] - a[1]).forEach(([bidang, count]) => {
                        log(`      - ${bidang}: ${count} rows`, 'info');
                    });
                });
                
                log('', 'info');
                log('‚è≥ Checking rekapitulasi table...', 'warning');
                const { data: allRekap, error: err2 } = await supabaseClient
                    .from('rekapitulasi')
                    .select('*');
                
                if (err2) {
                    log('‚ùå ERROR querying rekapitulasi:', 'error');
                    log(JSON.stringify(err2, null, 2), 'error');
                } else {
                    log(`‚úÖ Total rows in rekapitulasi: ${allRekap.length}`, 'success');
                    if (allRekap.length > 0) {
                        log('', 'info');
                        log('üìä Rekapitulasi data:', 'info');
                        allRekap.forEach(row => {
                            log(`   ${row.bulan} ${row.tahun} - ${row.bidang || 'N/A'}`, 'success');
                        });
                    }
                }
                
            } catch (err) {
                log('‚ùå EXCEPTION:', 'error');
                log(err.message, 'error');
                log(err.stack, 'error');
            }
        }
        
        async function testQuery() {
            clearResult();
            const tahun = parseInt(document.getElementById('tahun').value);
            const bulan = document.getElementById('bulan').value;
            const bidang = document.getElementById('bidang').value;
            
            log('='.repeat(60), 'info');
            log('üîç TESTING QUERY ABSENSI', 'success');
            log('='.repeat(60), 'info');
            log(`üìå Parameters:`, 'info');
            log(`   Tahun: ${tahun} (type: ${typeof tahun})`, 'info');
            log(`   Bulan: "${bulan}" (type: ${typeof bulan})`, 'info');
            log(`   Bidang: "${bidang}" (type: ${typeof bidang})`, 'info');
            log('', 'info');
            
            try {
                log('‚è≥ Executing query...', 'warning');
                
                const { data, error } = await supabaseClient
                    .from('absensi')
                    .select('*')
                    .eq('tahun', tahun)
                    .eq('bulan', bulan)
                    .eq('bidang', bidang)
                    .order('tanggal', { ascending: true });
                
                if (error) {
                    log('‚ùå ERROR:', 'error');
                    log(JSON.stringify(error, null, 2), 'error');
                    return;
                }
                
                if (!data || data.length === 0) {
                    log('‚ö†Ô∏è NO DATA FOUND!', 'warning');
                    log('', 'info');
                    log('üí° Possible reasons:', 'warning');
                    log('   1. Data belum diupload untuk bulan ini', 'warning');
                    log('   2. Format bulan tidak match (cek case sensitivity)', 'warning');
                    log('   3. Bidang tidak match (cek spelling)', 'warning');
                    return;
                }
                
                log(`‚úÖ SUCCESS! Found ${data.length} rows`, 'success');
                log('', 'info');
                log('üìä Sample data (first 3 rows):', 'info');
                log(JSON.stringify(data.slice(0, 3), null, 2), 'info');
                log('', 'info');
                log('üìà Statistics:', 'success');
                
                const totalWfo = data.reduce((sum, row) => sum + (row.wfo || 0), 0);
                const totalDinas = data.reduce((sum, row) => sum + (row.dinas_luar || 0), 0);
                const totalUndangan = data.reduce((sum, row) => sum + (row.undangan || 0), 0);
                const totalSakit = data.reduce((sum, row) => sum + (row.sakit || 0), 0);
                const totalIjin = data.reduce((sum, row) => sum + (row.ijin || 0), 0);
                const totalCuti = data.reduce((sum, row) => sum + (row.cuti || 0), 0);
                const totalAlpha = data.reduce((sum, row) => sum + (row.tidak_absen || 0), 0);
                
                log(`   WFO: ${totalWfo}`, 'success');
                log(`   Dinas Luar: ${totalDinas}`, 'success');
                log(`   Undangan: ${totalUndangan}`, 'success');
                log(`   Sakit: ${totalSakit}`, 'success');
                log(`   Ijin: ${totalIjin}`, 'success');
                log(`   Cuti: ${totalCuti}`, 'success');
                log(`   Tidak Absen: ${totalAlpha}`, 'success');
                log(`   TOTAL: ${totalWfo + totalDinas + totalUndangan + totalSakit + totalIjin + totalCuti + totalAlpha}`, 'success');
                
            } catch (err) {
                log('‚ùå EXCEPTION:', 'error');
                log(err.message, 'error');
                log(err.stack, 'error');
            }
        }
        
        async function testRekapitulasi() {
            clearResult();
            const tahun = parseInt(document.getElementById('tahun').value);
            const bulan = document.getElementById('bulan').value;
            
            log('='.repeat(60), 'info');
            log('üìä TESTING QUERY REKAPITULASI', 'success');
            log('='.repeat(60), 'info');
            log(`üìå Parameters: ${bulan} ${tahun}`, 'info');
            log('', 'info');
            
            try {
                const { data, error } = await supabaseClient
                    .from('rekapitulasi')
                    .select('*')
                    .eq('bulan', bulan)
                    .eq('tahun', tahun)
                    .single();
                
                if (error) {
                    if (error.code === 'PGRST116') {
                        log('‚ö†Ô∏è No rekapitulasi data found (this is OK)', 'warning');
                    } else {
                        log('‚ùå ERROR:', 'error');
                        log(JSON.stringify(error, null, 2), 'error');
                    }
                    return;
                }
                
                log('‚úÖ SUCCESS! Rekapitulasi data found:', 'success');
                log(JSON.stringify(data, null, 2), 'success');
                
            } catch (err) {
                log('‚ùå EXCEPTION:', 'error');
                log(err.message, 'error');
            }
        }

        // Auto-run on load
        window.addEventListener('load', () => {
            log('‚úÖ Supabase client initialized', 'success');
            log('üîó URL: ' + SUPABASE_URL, 'info');
            log('', 'info');
            log('üëâ Click "CHECK ALL DATABASE" button to start!', 'warning');
        });
    </script>
</body>
</html>
